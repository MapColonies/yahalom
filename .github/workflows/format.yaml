name: Format & Style Check

on:
  workflow_call:

jobs:
  format_check:
    name: Verify .editorconfig + Rider rules
    runs-on: ubuntu-latest

    env:
      SOLUTION_PATH: yahalom.sln

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install JetBrains ReSharper Global Tools (jb)
        run: |
          dotnet tool install --global JetBrains.ReSharper.GlobalTools
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Restore solution
        run: dotnet restore "$SOLUTION_PATH"

      - name: Check .editorconfig compliance (dotnet format)
        run: |
          dotnet format "$SOLUTION_PATH" \
            --no-restore \
            --verify-no-changes \
            --severity error \
            --include ./Assets

      - name: Run Rider cleanup (scoped to Assets only)
        run: |
          jb cleanupcode "$SOLUTION_PATH" \
            --no-build \
            --verbosity=WARN \
            --include="Assets/**/*.cs" \
            --exclude="**/bin/**" \
            --exclude="**/obj/**" \
            --exclude="**/.idea/**"

      - name: Fail if Rider cleanup would change files (Assets C# only)
        run: |
          if ! git diff --quiet --exit-code -- 'Assets/**/*.cs'; then
            echo "Rider Code Cleanup would change files in Assets/. Please run it locally and commit the changes."
            git --no-pager diff --name-only -- 'Assets/**/*.cs'
            exit 1
          fi

      - name: Verify trailing newline at EOF (Assets C# only)
        run: |
          echo "Checking trailing newline at EOF on Assets/**/*.cs ..."
          bad_files=$(find ./Assets -type f -name '*.cs' -print0 \
            | xargs -0 -I{} sh -c 'tail -c1 "{}" | grep -q "^$" || echo "{}"')
          if [ -n "$bad_files" ]; then
            echo "❌ Missing final newline in:"
            echo "$bad_files"
            exit 1
          else
            echo "✅ All Assets/**/*.cs end with a newline"
          fi
