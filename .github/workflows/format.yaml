name: Format Check

on:
  workflow_call:

jobs:
  format_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install JetBrains ReSharper Global Tools (jb)
        run: |
          dotnet tool install --global JetBrains.ReSharper.GlobalTools
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Restore solution (ensures everything loads)
        run: dotnet restore ./yahalom.sln

      - name: Run Rider Code Cleanup (check only)
        run: |
          jb cleanupcode ./yahalom.sln \
            --profile="Built-in: Reformat Code" \
            --no-build \
            --verbosity=WARN \
            --include="**/*.cs" \
            --exclude="**/bin/**" \
            --exclude="**/obj/**" \
            --exclude="**/.idea/**" \
            --exclude="**/Library/**" \
            --exclude="**/Temp/**" \
            --exclude="**/Logs/**"

      - name: Diff and annotate changes
        id: diff
        shell: bash
        run: |
          DIFF_FILE=cleanup.diff
          git --no-pager diff --unified=0 -- '*.cs' > "$DIFF_FILE" || true
          echo "diff_file=$DIFF_FILE" >> "$GITHUB_OUTPUT"
          if [ -s "$DIFF_FILE" ]; then echo "has_changes=true" >> "$GITHUB_OUTPUT"; else echo "has_changes=false" >> "$GITHUB_OUTPUT"; fi

      - name: Report files/lines that need formatting
        if: steps.diff.outputs.has_changes == 'true'
        shell: bash
        run: |
          awk '
            BEGIN { file="" }
            /^\+\+\+ b\// { sub(/^\+\+\+ b\//, "", $0); file=$0; next }
            /^@@ / {
              match($0, /\+([0-9]+)(,([0-9]+))?/, m)
              start = m[1]
              printf("::error file=%s,line=%d,title=Formatting differs::Run Rider Code Cleanup (Built-in: Reformat Code) and commit.\n", file, start)
            }
          ' "${{ steps.diff.outputs.diff_file }}"
          echo "::error title=Formatting check failed::Some files differ from the Rider/Resharper style. Run 'Code Cleanup' in Rider or 'jb cleanupcode yahalom.sln' locally."
          exit 1
