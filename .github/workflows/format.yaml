name: Format

on:
  workflow_call:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  format_check:
    name: Verify formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install JetBrains ReSharper Global Tools (jb)
        run: |
          dotnet tool install --global JetBrains.ReSharper.GlobalTools
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Restore (ensure solution loads cleanly)
        run: dotnet restore ./yahalom.sln

      - name: Run Rider cleanup
        run: |
          jb cleanupcode ./yahalom.sln \
            --no-build \
            --verbosity=WARN

      - name: Check for changes and summarize
        run: |
          if ! git diff --quiet; then
            echo "### ⚠️ Formatting changes detected by Rider/ReSharper" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The following files are not correctly formatted:" >> "$GITHUB_STEP_SUMMARY"
            git diff --name-only >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "➡️ Run \`jb cleanupcode yahalom.sln\` locally and commit the changes." >> "$GITHUB_STEP_SUMMARY"
            echo
            echo "Files needing formatting:"
            git diff --name-only
            echo
            echo "Diff preview (truncated):"
            # Show a truncated unified diff in logs for quick inspection; full diff available via 'git diff'
            git diff --color | head -n 500
            exit 1
          fi
